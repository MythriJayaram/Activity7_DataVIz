<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Car Data Scatter Plot</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
        }
        .plot-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }
        svg {
            width: 48%; /* Make the plots take up 48% of the container width */
            height: 500px; /* Reduce the height of the scatter plots */
        }
        #selected-list {
            width: 100%;
            padding: 10px;
            list-style-type: none;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        #selected-list li {
            padding: 5px 10px;
            margin: 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }
        .dot {
            cursor: pointer;
            stroke-width: 0;
            transition: stroke-width 0.2s ease;
        }
        .dot.selected {
            stroke: black;
            stroke-width: 3px;
        }
        .axis-label {
            font-size: 14px; /* Slightly reduce font size of axis labels */
        }
        .title {
            font-size: 18px; /* Make the title a bit smaller */
            font-weight: bold;
        }
        .legend-item text {
            font-size: 12px; /* Smaller text for legend items */
        }
        .legend-item {
            cursor: pointer;
        }
        .legend-item.inactive rect {
            fill-opacity: 0.2;
        }
        .legend-item.inactive text {
            opacity: 0.5;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="plot-container">
        <svg id="figure1"></svg>
        <svg id="figure2"></svg>
    </div>
    <ul id="selected-list"></ul>

    <script>
        let activeCountries = new Set(["USA", "Korea", "Japan", "Mexico", "Germany", "France", "Sweden"]);
        let selectedData = new Set();

        function scatter_plot(data, svgSelector, { title = "", xCol = "", yCol = "", rCol = "", colorCol = "", margin = { top: 60, right: 180, bottom: 80, left: 80 } } = {}) {
            const svg = d3.select(svgSelector);
            svg.selectAll("*").remove();
            
            const width = 700 - margin.left - margin.right;  // Adjust width to make the plot smaller
            const height = 500 - margin.top - margin.bottom; // Adjust height

            const chart = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => +d[xCol]))
                .range([0, width])
                .nice();
                
            const yScale = d3.scaleLinear()
                .domain(d3.extent(data, d => +d[yCol]))
                .range([height, 0])
                .nice();

            const rScale = d3.scaleLinear()
                .domain(d3.extent(data, d => +d[rCol]))
                .range([3, 15]);

            const colorScale = d3.scaleOrdinal()
                .domain(activeCountries)
                .range(["#4169E1", "#E47833", "#CD5C5C", "#66CDAA", "#228B22", "#FFFF00", "#800080"]);

            chart.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(0,${height + 10})`)
                .call(d3.axisBottom(xScale).ticks(5));

            chart.append("g")
                .attr("class", "y-axis")
                .call(d3.axisLeft(yScale).ticks(5));

            chart.append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", height + 50)
                .style("text-anchor", "middle")
                .text(xCol);

            chart.append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -40)
                .style("text-anchor", "middle")
                .text(yCol);

            svg.append("text")
                .attr("class", "title")
                .attr("x", (width + margin.left + margin.right) / 2)
                .attr("y", 30)
                .style("text-anchor", "middle")
                .text(title);

            const dots = chart.selectAll(".dot")
                .data(data)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(+d[xCol]))
                .attr("cy", d => yScale(+d[yCol]))
                .attr("r", d => rScale(+d[rCol]))
                .attr("fill", d => colorScale(d[colorCol]))
                .style("opacity", 0.7)
                .on('click', function(event, d) {
                    if (selectedData.has(d)) {
                        selectedData.delete(d);
                    } else {
                        selectedData.add(d);
                    }
                    updateSelectedList(Array.from(selectedData));
                    d3.select(this).classed('selected', selectedData.has(d));
                    updateSelectedPointsInBothGraphs();
                });

            // Create legend
            const legend = chart.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${width + 20}, ${margin.top})`);

            const legendItems = legend.selectAll(".legend-item")
                .data(colorScale.domain())
                .enter().append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(0, ${i * 30})`)
                .on("click", function(event, d) {
                    if (activeCountries.has(d)) {
                        activeCountries.delete(d);
                    } else {
                        activeCountries.add(d);
                    }
                    updateLegend();
                    updateDotsVisibility();
                });

            legendItems.append("rect")
                .attr("width", 20)
                .attr("height", 20)
                .attr("fill", colorScale);

            legendItems.append("text")
                .attr("x", 30)
                .attr("y", 15)
                .text(d => d);

            function updateLegend() {
              legendItems.classed('inactive', d => !activeCountries.has(d));
              legendItems.selectAll('rect').style('fill-opacity', d => activeCountries.has(d) ? null : '0.2');
              legendItems.selectAll('text').style('opacity', d => activeCountries.has(d) ? null : '0.5');
          }

          function updateDotsVisibility() {
              dots.style('display', d => activeCountries.has(d[colorCol]) ? null : 'none');
          }

          if (svgSelector === "#figure1") {
              const brush = d3.brush()
                  .extent([[0, 0], [width, height]])
                  .on("end", brushed);

              chart.append("g")
                  .attr("class", "brush")
                  .call(brush);

              function brushed(event) {
                  if (!event.selection) {
                      selectedData.clear();
                  } else {
                      const [[x0, y0], [x1, y1]] = event.selection;

                      selectedData = new Set(data.filter(d => {
                          const x = xScale(+d[xCol]);
                          const y = yScale(+d[yCol]);
                          return x >= x0 && x <= x1 && y >= y0 && y <= y1 && activeCountries.has(d[colorCol]);
                      }));
                  }
                  updateSelectedPoints();
                  updateSelectedList(Array.from(selectedData));
              }

              function updateSelectedPoints() {
                  dots.classed("selected", d => selectedData.has(d));
                  updateSelectedPointsInBothGraphs();
              }

              function updateSelectedPointsInBothGraphs() {
                  ["#figure1","#figure2"].forEach(selector => {
                      d3.select(selector).selectAll(".dot").classed('selected', (d) => selectedData.has(d));
                  });
              }
          }
      }

      function updateSelectedList(selectedDataArray) {
          const selectedList = d3.select("#selected-list");
          selectedList.selectAll("*").remove();  // Clear the list before appending new items

          selectedDataArray.forEach(d => {
              selectedList.append("li").text(`${d.Model} - ${d.Type}`);
          });
      }

      d3.csv('./data/car_sample_data.csv').then(data => {
          scatter_plot(data, '#figure1', { title: 'MPG vs Price', xCol: 'Price', yCol: 'MPG', rCol: 'Weight', colorCol: 'Country' });
          scatter_plot(data, '#figure2', { title: 'MPG vs Engine Size', xCol: 'EngineSizeCI', yCol: 'MPG', rCol: 'Price', colorCol: 'Country' });
      });
    </script>
</body>
</html>
